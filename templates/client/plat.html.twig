<!DOCTYPE html>
<html>
<head>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">

<button onclick="togglePanier()" id="panierBtn" class="fixed top-6 right-6 bg-black text-white px-4 py-2 rounded-lg">
 ðŸ›’ Panier ({{ panier.getPanierItems()|length }})
</button>

<div class="grid grid-cols-3 gap-6 mt-6">
{% for plat in plats %}
<div class="bg-white p-4 rounded-xl shadow">
    <h3 class="font-bold text-lg">{{ plat.nom }}</h3>
    <p class="text-gray-500">{{ plat.prix }} DH</p>
    <button class="add-to-panier block mt-3 bg-black text-white text-center py-2 rounded-lg" data-id="{{ plat.id }}">
        Ajouter au panier
    </button>
</div>
{% endfor %}
</div>

<div id="panierPanel" class="fixed top-0 right-0 h-full w-96 bg-white shadow-2xl transform translate-x-full transition-all p-6 space-y-4">
<h2 class="text-xl font-bold">Votre panier</h2>

<div id="panierItems"></div>

<div class="border-t pt-4 space-y-2">
  
  <p>Sous-total: <b id="sousTotal">0</b> DH</p>
  <p>Livraison: 15 DH</p>
  <p class="text-xl font-bold">Total: <b id="total">15</b> DH</p>
  <button class="w-full bg-black text-white py-2 rounded-lg mt-3">Commander</button>
  <button id="viderPanier" class="w-full bg-red-600 text-white py-2 rounded-lg mb-2">Vider le panier</button>
</div>
</div>

<script>
function togglePanier() {
    document.getElementById('panierPanel').classList.toggle('translate-x-full');
}

function renderPanier(data){
    const panierDiv = document.getElementById('panierItems');
    panierDiv.innerHTML = '';
    data.items.forEach(item => {
        const div = document.createElement('div');
        div.className = 'flex justify-between border-b pb-3';
        div.innerHTML = `
            <div>
                <p class="font-semibold">${item.nom}</p>
                <p class="item-sub">${item.sub} DH</p>
            </div>
            <div class="flex items-center gap-2">
                <button class="update-btn" data-id="${item.id}" data-change="-1">âž–</button>
                <span class="item-quantity">${item.quantity}</span>
                <button class="update-btn" data-id="${item.id}" data-change="1">âž•</button>
                <button class="remove-btn" data-id="${item.id}">ðŸ—‘</button>
            </div>
        `;
        panierDiv.appendChild(div);
    });
    document.getElementById('sousTotal').textContent = data.total;
    document.getElementById('total').textContent = data.total + 15;
    document.getElementById('panierBtn').textContent = `ðŸ›’ Panier (${data.totalItems})`;

    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
    document.querySelectorAll('.update-btn').forEach(btn=>{
        btn.onclick = () => {
            const id = btn.dataset.id;
            const change = parseInt(btn.dataset.change);
            let qty = parseInt(btn.parentElement.querySelector('.item-quantity').textContent);
            let newQty = qty + change;
            if(newQty < 0) newQty=0;
            fetch(`/client/panier/update/${id}/${newQty}`, {method:'POST', headers:{'X-Requested-With':'XMLHttpRequest'}})
                .then(res=>res.json()).then(renderPanier);
        };
    });

    document.querySelectorAll('.remove-btn').forEach(btn=>{
        btn.onclick = () => {
            const id = btn.dataset.id;
            fetch(`/client/panier/remove/${id}`, {method:'POST', headers:{'X-Requested-With':'XMLHttpRequest'}})
                .then(res=>res.json()).then(renderPanier);
        };
    });
}

// Ajouter au panier
document.querySelectorAll('.add-to-panier').forEach(btn=>{
    btn.onclick = ()=>{
        const id = btn.dataset.id;
        fetch(`/client/panier/add/${id}`, {method:'POST', headers:{'X-Requested-With':'XMLHttpRequest'}})
            .then(res=>res.json()).then(renderPanier);
    };
});

// Vider panier
document.getElementById('viderPanier').onclick = ()=>{
    fetch(`/client/panier/vider`, {method:'POST', headers:{'X-Requested-With':'XMLHttpRequest'}})
        .then(res=>res.json()).then(renderPanier);
};

// initial render
renderPanier({
    items: [
        {% for item in panier.getPanierItems() %}
        {
            id: {{ item.id }},
            nom: "{{ item.plat.nom }}",
            prix: {{ item.plat.prix }},
            quantity: {{ item.quantity }},
            sub: {{ item.quantity * item.plat.prix }}
        },
        {% endfor %}
    ],
    total: {{ panier.getPanierItems()|reduce((sum,item)=>sum + item.quantity*item.plat.prix,0) }},
    totalItems: {{ panier.getPanierItems()|length }}
});
</script>

</body>
</html>
