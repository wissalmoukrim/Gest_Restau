{% extends 'base_dashboard.html.twig' %}

{% block title %}üöö Espace Livreur - La Table Gourmande{% endblock %}

{% block body %}
<div class="min-h-screen bg-gradient-to-br from-gray-50 to-blue-50 p-4 md:p-6">
    <!-- En-t√™te -->
    <div class="mb-8">
        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
            <div class="flex items-center gap-4">
                <div class="p-3 bg-gradient-to-br from-green-500 to-blue-600 rounded-2xl shadow-lg">
                    <i class="fas fa-truck text-white text-2xl"></i>
                </div>
                <div>
                    <h1 class="text-3xl md:text-4xl font-bold text-gray-800">
                        Bonjour Livreur 
                        <span class="text-blue-600">{{ app.user.prenom ?? app.user.email|split('@')|first }}</span> !
                    </h1>
                    <p class="text-gray-600 mt-2">G√©rez vos livraisons en cours et √† venir</p>
                </div>
            </div>
            
            <div class="flex items-center gap-3">
                <a href="{{ path('dashboard') }}" 
                   class="inline-flex items-center gap-2 bg-gradient-to-r from-gray-600 to-gray-700 
                          hover:from-gray-700 hover:to-gray-800 text-white px-5 py-2.5 
                          rounded-lg font-bold transition-all hover:shadow-lg hover:-translate-y-0.5">
                    <i class="fas fa-arrow-left"></i>
                    Retour au dashboard
                </a>
                
                <button onclick="location.reload()" 
                        class="inline-flex items-center gap-2 bg-gradient-to-r from-blue-500 to-blue-600 
                               hover:from-blue-600 hover:to-blue-700 text-white px-5 py-2.5 
                               rounded-lg font-bold transition-all hover:shadow-lg hover:-translate-y-0.5">
                    <i class="fas fa-redo"></i>
                    Actualiser
                </button>
            </div>
        </div>

        <!-- Statistiques -->
        <div class="bg-white/80 backdrop-blur-sm rounded-xl p-6 shadow-lg border border-blue-200 mb-8">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div class="bg-gradient-to-br from-blue-50 to-blue-100 border border-blue-200 rounded-xl p-5">
                    <div class="flex items-center justify-between mb-3">
                        <div class="p-2 bg-blue-500 rounded-lg">
                            <i class="fas fa-box text-white"></i>
                        </div>
                        <span class="text-2xl font-bold text-blue-700">
                            {{ commandes|length }}
                        </span>
                    </div>
                    <h3 class="font-bold text-blue-800 mb-1">Commandes √† livrer</h3>
                    <p class="text-blue-600 text-sm">Pr√™tes ou en cours</p>
                </div>
                
                <div class="bg-gradient-to-br from-green-50 to-green-100 border border-green-200 rounded-xl p-5">
                    <div class="flex items-center justify-between mb-3">
                        <div class="p-2 bg-green-500 rounded-lg">
                            <i class="fas fa-check-circle text-white"></i>
                        </div>
                        <span class="text-2xl font-bold text-green-700">
                            {{ commandes|filter(c => c.statut == 'terminee')|length }}
                        </span>
                    </div>
                    <h3 class="font-bold text-green-800 mb-1">Livr√©es aujourd'hui</h3>
                    <p class="text-green-600 text-sm">Mission accomplie</p>
                </div>
                
                <div class="bg-gradient-to-br from-amber-50 to-amber-100 border border-amber-200 rounded-xl p-5">
                    <div class="flex items-center justify-between mb-3">
                        <div class="p-2 bg-amber-500 rounded-lg">
                            <i class="fas fa-clock text-white"></i>
                        </div>
                        <span class="text-2xl font-bold text-amber-700">
                            {{ commandes|filter(c => c.statut == 'en_livraison')|length }}
                        </span>
                    </div>
                    <h3 class="font-bold text-amber-800 mb-1">En cours</h3>
                    <p class="text-amber-600 text-sm">Livraisons actives</p>
                </div>
                
                <div class="bg-gradient-to-br from-purple-50 to-purple-100 border border-purple-200 rounded-xl p-5">
                    <div class="flex items-center justify-between mb-3">
                        <div class="p-2 bg-purple-500 rounded-lg">
                            <i class="fas fa-map-marker-alt text-white"></i>
                        </div>
                        <span class="text-2xl font-bold text-purple-700">
                            {{ commandes|filter(c => c.livreur == app.user)|length }}
                        </span>
                    </div>
                    <h3 class="font-bold text-purple-800 mb-1">Mes missions</h3>
                    <p class="text-purple-600 text-sm">Assign√©es √† moi</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Contenu principal -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Colonne gauche : Commandes √† livrer -->
        <div>
            <div class="bg-white rounded-2xl shadow-lg border border-blue-200 overflow-hidden">
                <!-- Header -->
                <div class="bg-gradient-to-r from-blue-600 to-blue-700 p-6">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="p-2 bg-white/20 rounded-lg">
                                <i class="fas fa-shipping-fast text-white text-xl"></i>
                            </div>
                            <div>
                                <h2 class="text-2xl font-bold text-white">üì¶ Commandes √† Livrer</h2>
                                <p class="text-blue-100">Pr√™tes et en cours de livraison</p>
                            </div>
                        </div>
                        <span class="bg-white text-blue-700 px-4 py-1 rounded-full font-bold">
                            {{ commandes|length }}
                        </span>
                    </div>
                </div>
                
                <!-- Contenu -->
                <div class="p-6">
                    {% if commandes|length > 0 %}
                        <div class="space-y-6">
                            {% for commande in commandes %}
                            <div class="border border-gray-200 rounded-xl p-5 hover:shadow-md transition">
                                <!-- En-t√™te commande -->
                                <div class="flex justify-between items-start mb-4">
                                    <div>
                                        <h3 class="text-xl font-bold text-gray-800">Commande #{{ commande.id }}</h3>
                                        <p class="text-gray-500 text-sm mt-1">
                                            <i class="fas fa-clock mr-1"></i>
                                            {{ commande.date|date('d/m/Y H:i') }}
                                        </p>
                                    </div>
                                    
                                    <!-- Badge statut -->
                                    <span class="px-3 py-1 rounded-full text-sm font-bold
                                        {% if commande.statut == 'prete' %} 
                                            bg-blue-100 text-blue-800
                                        {% elseif commande.statut == 'en_livraison' %}
                                            bg-amber-100 text-amber-800 animate-pulse
                                        {% else %}
                                            bg-gray-100 text-gray-800
                                        {% endif %}">
                                        <i class="fas 
                                            {% if commande.statut == 'prete' %}fa-box
                                            {% elseif commande.statut == 'en_livraison' %}fa-truck-moving
                                            {% else %}fa-box-open{% endif %} 
                                            mr-1">
                                        </i>
                                        {{ commande.statut|replace({'_': ' '})|title }}
                                    </span>
                                </div>
                                
                                <!-- Informations client -->
                                <div class="mb-4 p-3 bg-gray-50 rounded-lg">
                                    <div class="flex items-center gap-3 mb-2">
                                        <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-600 
                                                    rounded-full flex items-center justify-center">
                                            <i class="fas fa-user text-white"></i>
                                        </div>
                                        <div>
                                            <p class="font-bold text-gray-800">
                                                {{ commande.user.nom ?? 'Client' }} {{ commande.user.prenom ?? '' }}
                                            </p>
                                            <p class="text-sm text-gray-600">
                                                {% if commande.user.telephone %}
                                                    <i class="fas fa-phone mr-1"></i>{{ commande.user.telephone }}
                                                {% endif %}
                                            </p>
                                        </div>
                                    </div>
                                    
                                    <!-- Adresse -->
                                    {% if commande.adresseLivraison %}
                                    <div class="mt-3">
                                        <p class="text-sm font-medium text-gray-700 mb-1">
                                            <i class="fas fa-map-marker-alt text-red-500 mr-2"></i>
                                            Adresse de livraison
                                        </p>
                                        <p class="text-gray-600">{{ commande.adresseLivraison }}</p>
                                    </div>
                                    {% endif %}
                                </div>
                                
                                <!-- D√©tails commande -->
                                <div class="mb-4">
                                    <h4 class="font-bold text-gray-700 mb-2 flex items-center gap-2">
                                        <i class="fas fa-utensils text-amber-600"></i>
                                        Contenu de la commande
                                    </h4>
                                    <div class="space-y-2 max-h-40 overflow-y-auto pr-2">
                                        {% for item in commande.commandeItems %}
                                        <div class="flex justify-between items-center p-2 bg-gray-50 rounded-lg">
                                            <div>
                                                <p class="font-medium text-gray-800">{{ item.plat.nom }}</p>
                                                <p class="text-xs text-gray-500">√ó {{ item.quantite }}</p>
                                            </div>
                                            <p class="text-gray-700 font-bold">{{ item.quantite * item.prixUnitaire }} DH</p>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                                
                                <!-- Total et actions -->
                                <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                                    <div>
                                        <p class="text-gray-500 text-sm">Montant total</p>
                                        <p class="text-2xl font-bold text-green-600">{{ commande.total }} DH</p>
                                    </div>
                                    
                                    <!-- Bouton d'action -->
                                    <form method="post" 
                                          action="{{ path('livreur_commande_livrer', {id: commande.id}) }}"
                                          class="w-full sm:w-auto">
                                        <input type="hidden" name="_token" value="{{ csrf_token('livrer' ~ commande.id) }}">
                                        
                                        <button type="submit" 
                                                class="w-full inline-flex items-center justify-center gap-2 
                                                       {% if commande.statut == 'prete' %}
                                                           bg-gradient-to-r from-blue-500 to-blue-600 
                                                           hover:from-blue-600 hover:to-blue-700
                                                       {% else %}
                                                           bg-gradient-to-r from-green-500 to-green-600 
                                                           hover:from-green-600 hover:to-green-700
                                                       {% endif %}
                                                       text-white px-6 py-3 rounded-lg font-bold 
                                                       transition-all hover:shadow-lg hover:-translate-y-0.5">
                                            <i class="fas 
                                                {% if commande.statut == 'prete' %}fa-play-circle
                                                {% else %}fa-flag-checkered{% endif %}">
                                            </i>
                                            {% if commande.statut == 'prete' %}
                                                D√©marrer la livraison
                                            {% else %}
                                                Marquer comme livr√©e
                                            {% endif %}
                                        </button>
                                        
                                        {% if commande.statut == 'en_livraison' %}
                                        <p class="text-xs text-gray-500 mt-2 text-center">
                                            <i class="fas fa-info-circle mr-1"></i>
                                            Appuyez lorsque la commande est livr√©e
                                        </p>
                                        {% endif %}
                                    </form>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <!-- Aucune commande -->
                        <div class="text-center py-12">
                            <div class="w-24 h-24 mx-auto mb-6 bg-gradient-to-br from-blue-100 to-blue-200 
                                        rounded-full flex items-center justify-center">
                                <i class="fas fa-truck text-blue-400 text-4xl"></i>
                            </div>
                            <h3 class="text-2xl font-bold text-blue-700 mb-3">Aucune commande √† livrer</h3>
                            <p class="text-gray-600 mb-6">Toutes les commandes sont livr√©es ou en attente de pr√©paration</p>
                            
                            <div class="flex flex-col sm:flex-row gap-4 justify-center">
                                <button onclick="location.reload()" 
                                        class="inline-flex items-center gap-2 bg-gradient-to-r 
                                               from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 
                                               text-white px-6 py-3 rounded-lg font-bold transition-all hover:shadow-lg">
                                    <i class="fas fa-redo"></i>
                                    Actualiser la page
                                </button>
                                
                                <a href="{{ path('dashboard') }}" 
                                   class="inline-flex items-center gap-2 border-2 
                                          border-gray-300 text-gray-700 hover:bg-gray-50 
                                          px-6 py-3 rounded-lg font-bold transition">
                                    <i class="fas fa-home"></i>
                                    Retour √† l'accueil
                                </a>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Colonne droite : Carte et instructions -->
        <div>
            <!-- Carte fictive -->
            <div class="bg-white rounded-2xl shadow-lg border border-gray-200 overflow-hidden mb-8">
                <div class="bg-gradient-to-r from-gray-800 to-gray-900 p-6">
                    <div class="flex items-center gap-3">
                        <div class="p-2 bg-white/20 rounded-lg">
                            <i class="fas fa-map text-white"></i>
                        </div>
                        <div>
                            <h2 class="text-xl font-bold text-white">üó∫Ô∏è Itin√©raire & Navigation</h2>
                            <p class="text-gray-300 text-sm">Suivez vos livraisons</p>
                        </div>
                    </div>
                </div>
                
                <div class="p-6">
                    <!-- Carte fictive -->
                    <div class="bg-gray-100 rounded-xl h-64 mb-4 flex items-center justify-center">
                        <div class="text-center">
                            <i class="fas fa-map-marked-alt text-gray-400 text-5xl mb-3"></i>
                            <p class="text-gray-500">Carte de navigation</p>
                            <p class="text-gray-400 text-sm">(Int√©gration Google Maps possible)</p>
                        </div>
                    </div>
                    
                    <!-- Instructions -->
                    <div class="space-y-3">
                        <div class="flex items-center gap-3 p-3 bg-blue-50 rounded-lg">
                            <div class="p-2 bg-blue-100 rounded-lg">
                                <i class="fas fa-clipboard-check text-blue-600"></i>
                            </div>
                            <div>
                                <p class="font-bold text-blue-800">V√©rifiez la commande</p>
                                <p class="text-blue-600 text-sm">Assurez-vous que tous les articles sont pr√©sents</p>
                            </div>
                        </div>
                        
                        <div class="flex items-center gap-3 p-3 bg-green-50 rounded-lg">
                            <div class="p-2 bg-green-100 rounded-lg">
                                <i class="fas fa-phone-alt text-green-600"></i>
                            </div>
                            <div>
                                <p class="font-bold text-green-800">Contactez le client</p>
                                <p class="text-green-600 text-sm">Appelez 10 min avant l'arriv√©e</p>
                            </div>
                        </div>
                        
                        <div class="flex items-center gap-3 p-3 bg-amber-50 rounded-lg">
                            <div class="p-2 bg-amber-100 rounded-lg">
                                <i class="fas fa-camera text-amber-600"></i>
                            </div>
                            <div>
                                <p class="font-bold text-amber-800">Preuve de livraison</p>
                                <p class="text-amber-600 text-sm">Prenez une photo si le client est absent</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Information livraison -->
            <div class="bg-white rounded-2xl shadow-lg border border-green-200 overflow-hidden">
                <div class="bg-gradient-to-r from-green-600 to-green-700 p-6">
                    <div class="flex items-center gap-3">
                        <div class="p-2 bg-white/20 rounded-lg">
                            <i class="fas fa-info-circle text-white"></i>
                        </div>
                        <div>
                            <h2 class="text-xl font-bold text-white">üìã Informations de Livraison</h2>
                            <p class="text-green-100 text-sm">Conseils et bonnes pratiques</p>
                        </div>
                    </div>
                </div>
                
                <div class="p-6">
                    <div class="space-y-4">
                        <div>
                            <h4 class="font-bold text-gray-800 mb-2">Heures de livraison</h4>
                            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                <span class="text-gray-700">Service du jour</span>
                                <span class="font-bold text-green-600">11h - 23h</span>
                            </div>
                        </div>
                        
                        <div>
                            <h4 class="font-bold text-gray-800 mb-2">Temps moyen par livraison</h4>
                            <div class="w-full bg-gray-200 rounded-full h-2 mb-1">
                                <div class="bg-blue-600 h-2 rounded-full" style="width: 75%"></div>
                            </div>
                            <p class="text-sm text-gray-600">Estimation : 25-35 minutes</p>
                        </div>
                        
                        <div>
                            <h4 class="font-bold text-gray-800 mb-2">Contact d'urgence</h4>
                            <div class="p-3 bg-red-50 border border-red-100 rounded-lg">
                                <p class="text-red-700 font-medium">
                                    <i class="fas fa-phone mr-2"></i>
                                    Support : 06 12 34 56 78
                                </p>
                                <p class="text-red-600 text-sm mt-1">En cas de probl√®me ou retard</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Pied de page -->
    <div class="mt-8 pt-6 border-t border-gray-200">
        <div class="flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-4">
                <div class="flex items-center gap-2">
                    <div class="w-3 h-3 {% if commandes|length > 0 %}bg-green-500{% else %}bg-gray-400{% endif %} rounded-full"></div>
                    <span class="text-sm text-gray-600">
                        {% if commandes|length > 0 %}
                            üü¢ Service actif
                        {% else %}
                            ‚ö´ En attente de commandes
                        {% endif %}
                    </span>
                </div>
                <div class="text-sm text-gray-500">
                    <i class="fas fa-clock mr-1"></i>
                    {{ "now"|date("H:i") }} ‚Ä¢ {{ "now"|date("d/m/Y") }}
                </div>
            </div>
            
            <div class="flex items-center gap-4">
                <a href="{{ path('livreur_interface') }}" 
                   class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                    <i class="fas fa-sliders-h mr-1"></i>
                    Interface Livreur
                </a>
                <a href="{{ path('app_logout') }}" 
                   class="text-red-600 hover:text-red-800 text-sm font-medium">
                    <i class="fas fa-sign-out-alt mr-1"></i>
                    D√©connexion
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Animation des cartes
    const cards = document.querySelectorAll('.border.border-gray-200');
    cards.forEach((card, index) => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(20px)';
        
        setTimeout(() => {
            card.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
        }, 100 * index);
    });
    
    // Auto-refresh toutes les 30 secondes
    setTimeout(() => {
        location.reload();
    }, 30000);
    
    // Confirmation avant livraison
    const forms = document.querySelectorAll('form[action*="livrer"]');
    forms.forEach(form => {
        form.addEventListener('submit', function(e) {
            const button = this.querySelector('button');
            const statut = button.textContent.includes('D√©marrer') ? 'd√©marrer' : 'terminer';
            
            if (!confirm(`√ätes-vous s√ªr de vouloir ${statut} cette livraison ?`)) {
                e.preventDefault();
            }
        });
    });
});

// Animation pour les livraisons en cours
const enLivraisonCards = document.querySelectorAll('[class*="bg-amber-100"]');
enLivraisonCards.forEach(card => {
    card.addEventListener('mouseenter', function() {
        this.style.transform = 'scale(1.02)';
    });
    
    card.addEventListener('mouseleave', function() {
        this.style.transform = 'scale(1)';
    });
});
</script>

<!-- Styles -->
<style>
/* Animation pulse pour les livraisons en cours */
.animate-pulse {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.7; }
    100% { opacity: 1; }
}

/* Scrollbar personnalis√©e */
.overflow-y-auto::-webkit-scrollbar {
    width: 6px;
}

.overflow-y-auto::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
}

.overflow-y-auto::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 3px;
}

/* Transition pour les cartes */
.border-gray-200 {
    transition: all 0.3s ease;
}

/* Effet de survol am√©lior√© */
.border-gray-200:hover {
    box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
}

/* Responsive */
@media (max-width: 768px) {
    .grid-cols-1 {
        grid-template-columns: 1fr;
    }
    
    .lg\\:grid-cols-2 {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock %}